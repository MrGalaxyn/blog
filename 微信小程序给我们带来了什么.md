# 微信小程序给我们带来了什么

-----

&emsp;&emsp;1月9日，伴随着100多个小程序的发布，微信小程序终于揭开了它神秘的面纱。在人口红利逐渐消失的今天，小程序的出现可能更多地是在寻找新的场景，可能是新的商业模式。那么作为一个普通的开发者，我们要不要跟进？这些天一直在思考这个问题，下面就谈一谈我的想法。

## 我们是不是需要跟进小程序

我觉得要回答这个问题，首先需要思考两个问题：

**1.微信为什么要做小程序?**

&emsp;&emsp;用官腔来回答当然是为了用户：它能提供更加方便的体验，通过更多“用完即走”的小工具为大家提供方便。但是企业的真正目的永远是追逐利益，对于微信自己来说，通过小程序可以完善它的生态，占有更多的流量，让用户更具黏性。

&emsp;&emsp;或许我们换个角度，分析下公众号的现状，可以更好地来说明为什么出现小程序。服务号的产生也是微信为了完善自己的生态。抛开给用户的各种便利不谈，服务号最大的问题就是他的体验不够好，依赖于网络且容易被手机的其他操作打断；微信将订阅消息统一到一个入口，又让公众号的层级隐藏的很深；最重要的是即使微信做了各种限制，公众号对于企业来讲的一个重要作用还是导流，通过公众号将微信的流量导到自己的App里面去，这不利于微信增加用户黏性。

&emsp;&emsp;另外，还有很多人可能有跟我一样的担忧，小程序是在“致敬”苹果公司的生态模式，那么有没有可能苹果爸爸不让你在这么玩了？从不能做游戏这个App Store里收入的大头就可以看出，微信还是很听话的。我们就不妄自揣测苹果与微信之间的协议了，但从腾讯一直以来的都是遵守各种政策的“模范”这点上来看，这点我们可能不用担心。

**2.对于企业来说，小程序又能给我们带来什么价值?**

&emsp;&emsp;从现在的套路来看，对于那些在乎自身流量的业务，肯定不适合小程序了。其实很好理解，如果你是通过自己App的流量变现的，如果你上了小程序，一部分流量肯定会被小程序分流，流量再也回不到自身的App。

&emsp;&emsp;我能想到的更多的是一些线下场景，toB的业务可能存在机会。举个最简单的例子，如果去超市购物，扫个码直接拿东西付款走人不用排队，那么我们的生活可是美滋滋。

## 小程序中的技术谈

对于企业来说，需要认真考虑小程序的使用场景谨慎使用，那么对于我们大多数开发者来说，还是要尽早接触的，谁让小程序这么火呢。。。

### 1.小程序说它能提供App，那么它到底使用了什么技术来完成？

&emsp;&emsp;古人说“知己知彼，百战百胜”，想要更好地使用小程序，我们当然需要先来挖一挖它的实现。其实想想小程序的使用场景，它的技术实现也不可能超出现有Hybrid App的思路。

**1）开发方式**

&emsp;&emsp;接触任何技术项目，读懂其技术文档都是第一步，因为很多关于该技术的关键都在文档中。

> 框架提供了自己的视图层描述语言 WXML 和 WXSS，以及基于 JavaScript 的逻辑层框架

&emsp;&emsp;微信选择使用自己的创造一种新的语言来完成小程序。类比下iOS下开发需要swift、OC，可能微信真的想用小程序来完成自己做操作系统的野心呀，至少人家也弄了一套新的语言。可能大家觉得这玩意又给自己增加了成本，但确实小程序的学习成本还是很低的，至少接个支付不用再费事了，一个API帮你搞定

**2) 运行环境**

&emsp;&emsp;我们接着来看技术文档中的这一段:

> 三端的脚本执行环境聚以及用于渲染非原生组件的环境是各不相同的：

> * 在 iOS 上，小程序的 javascript 代码是运行在 JavaScriptCore 中，是由 WKWebView 来渲染的，环境有 iOS8、iOS9、iOS10
> * 在 Android 上，小程序的 javascript 代码是通过 X5 JSCore来解析，是由 X5 基于 Mobile Chrome 37 内核来渲染的
> * 在 开发工具上， 小程序的 javascript 代码是运行在 nwjs 中，是由 Chrome Webview 来渲染的

&emsp;&emsp;既然有非原生组件，那么它的实现还是基于webview，并对其做了一些改造，提供缓存、前后台管理等功能，同时通过jsBridge来实现某些web端支持不好的组件，比如地图、视频等；

**3) 运行机制**

&emsp;&emsp;另一个文档中提到的关键点是小程序的生命周期，

<div align=center><img src="http://git.intra.weibo.com/Ria/blog/raw/master/mina-lifecycle.png" alt="" /><div align=center>图1. Page 实例的生命周期</div></div>

&emsp;&emsp;如图所示，我们可以看到小程序中存在两个非常重要的线程，一个叫View，一个叫AppService。这是一个很巧妙的设计：

&emsp;&emsp;首先，让开发者无法直接操作真正的渲染进程，从而实现对开发者最大程度的控制。

&emsp;&emsp;做个简单的类比，我们在做富文本编辑器的时候，为了防止用户的恶意攻击，肯定会做过滤，比如不能插入外链图片、script标签吧，这些都是基本的。类比到小程序里，这个AppService就是那个富文本编辑器，你想直接操作BOM没可能，所以你基本上也没啥可能干坏事了。

&emsp;&emsp;其次，通过这种方式，也帮助微信更好地做程序的监控，记录并优化某些操作的性能；甚至如果它们想，可以很容易的照着redux搞一套 [时间旅行](http://www.ibm.com/developerworks/cn/web/wa-manage-state-with-redux-p4-david-geary/index.html) 来回溯用户的操作

&emsp;&emsp;当然，这种机制的问题也很明显，就是执行效率。频繁的事件交互肯定会被每次调用时事件的组装、发送、解析所拖累。因此从技术角度来讲，可能这也是影响小程序来做游戏的一个因素吧。

**4）前后台操作**

&emsp;&emsp;既然是应用程序，就免不了应用前后台的操作，这也是原来h5应用所没有的生命周期管理，这块简单想想也不是很复杂。对于程序的前后台切换来说，实现起来应该很简单，需要后台运行时触发个事件告诉AppService线程，让它调用用户注册的回调处理就好了。如果后台运行时，用户需要开另一个小程序也好处理，一个程序一个webview，这应该不是难事。目前来看，微信中只可以保留一个小程序在聊天列表里后台运行，因此，对于驻留在后台时的资源消耗应该也不大，不会是个问题，而且应该产品上也不会放开让多个小程序后台运行吧。

**5）离线化**

&emsp;&emsp;小程序是应用，那么应用就需要离线化，离线主要就是解决如何缓存资源的问题啦。至少这个问题在我们微博已经解决的差不多了，说白了就是客户端上做个处理劫持webview的请求。我们的思路是客户端在wifi下提前加载个需要离线化的应用的静态资源包，当webview发起请求时，如果发现该请求访问的资源已经在加载好的静态资源包中，则直接返回，不在向外发送该请求。
因此，处于控制客户端占用空间大小的考虑，微信也会限制小程序的大小，规定一个应用的大小不能超过1m。

### 2.微信值得我们学习跟进么？

&emsp;&emsp;学，肯定要学。毕竟微信8亿用户量这体积，由此可能产生万千的玩法，也就需要万千份的开发，你不学人家学，万一真火了，丢掉饭碗的肯定是你，对不。

&emsp;&emsp;但我还是要吐吐槽，这种封闭的玩意，离开了微信什么也不是，如果有精力，当个业余爱好或者玩具吧。

&emsp;&emsp;当然，如果你真的有精力，尝试开发个兼容多端的框架可能也是个选择。抽了眼开发者工具的代码，里面也有个虚拟dom的算法把各个节点编程微信的DOM树，如果真的有精力，搞个兼容浏览器DOM与微信DOM的框架也是极好的。


### 总结

&emsp;&emsp;最后自己总结下，在人口红利即将结束的今日，小程序可能是引起变革的一个新爆点。它肯定不光面向长尾低频应用，B端用户的需求，或者做一些线下场景都是小程序的目标。

&emsp;&emsp;新事物总是值得尝试的，前提是要思考了它成本与收益。说点最实际的，小程序的开发方式跟Web App和Native App都不相同，如果不介意生产成本的话，就再给自己增加一条生产线吧




